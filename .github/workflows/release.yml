---
name: Release

on:
  workflow_dispatch:
    inputs:
      releaseVersion:
        description: "Version of the release."
        required: true
        default: "X.Y.Z"
      developmentVersion:
        description: "Version to use for new local working copy."
        required: true
        default: "X.Y+1.Z"
      java_version:
        description: Java version to use
        type: string
        required: false
        default: "17"
      dryRun:
        description: "Perform a dry run of the Maven Release"
        required: true
        default: false
        type: boolean
      skipJavaRelease:
        description: "Skip releasing the Java artifacts to Maven Central"
        required: true
        type: boolean
        default: false
      skipDartRelease:
        description: "Skip releasing the Dart artifacts to GitHub and pub.dev"
        required: true
        type: boolean
        default: false

jobs:
  maven-release:
    if: ${{ ! github.event.inputs.skipJavaRelease }}
    uses: jqassistant-tooling/jqassistant-github-actions/.github/workflows/release.yml@main
    with:
      branch: ${{ github.event.inputs.branch }}
      releaseVersion: ${{ github.event.inputs.releaseVersion }}
      developmentVersion: "${{ github.event.inputs.developmentVersion }}-SNAPSHOT"
      dryRun: ${{ github.event.inputs.dryRun }}
    secrets:
      ossrh_username: ${{ secrets.OSSRH_USERNAME }}
      ossrh_password: ${{ secrets.OSSRH_PASSWORD }}
      ossrh_signing_key: ${{ secrets.OSSRH_SIGNING_KEY }}
      ossrh_signing_password: ${{ secrets.OSSRH_SIGNING_PASSWORD }}
      sonar_token: ${{ secrets.SONAR_TOKEN }}
  prepare-dart-build:
    if: ${{ ! github.event.inputs.skipDartRelease }}
    needs: [ maven-release ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get
        working-directory: ./dart
      - name: Verify Package
        run: dart pub publish --dry-run
        working-directory: ./dart
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Set Dart artifact release version
        uses: fjogeleit/yaml-update-action@main
        with:
          valueFile: 'dart/pubspec.yaml'
          propertyPath: 'version'
          value: ${{ github.event.inputs.releaseVersion }}
          message: "prepare release version ${{ github.event.inputs.releaseVersion }} of LCE tool"
          branch: ${{ steps.extract_branch.outputs.branch }}
          createPR: false
  dart-build:
    if: ${{ ! github.event.inputs.skipDartRelease }}
    needs: [ prepare-dart-build ]
    runs-on: ${{ matrix.runs-on }}
    strategy:
      matrix:
        runs-on: [ ubuntu-latest, windows-latest, macos-13, macos-14 ]
        include:
          - runs-on: ubuntu-latest
            binary-name: jqa_dart_lce_linux_amd64
          - runs-on: macos-13
            binary-name: jqa_dart_lce_macos_amd64
          - runs-on: macos-14
            binary-name: jqa_dart_lce_macos_arm64
          - runs-on: windows-latest
            binary-name: jqa_dart_lce_windows_amd64.exe
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get
        working-directory: ./dart
      - name: Prepare Output Directories
        run: mkdir ${{ matrix.runs-on }}
        working-directory: ./dart
      - name: Compile Binaries
        run: dart compile exe bin/jqa_dart_lce.dart -o ${{ matrix.runs-on }}/${{ matrix.binary-name }}
        working-directory: ./dart
      - uses: actions/upload-artifact@v2
        with:
          name: bin-${{ matrix.runs-on }}
          path: ./dart/${{ matrix.runs-on }}
  dart-release:
    if: ${{ ! github.event.inputs.skipDartRelease }}
    needs: [ dart-build ]
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - uses: actions/checkout@v4
      - uses: dart-lang/setup-dart@v1
      - run: dart pub get
        working-directory: ./dart
      - uses: actions/download-artifact@v2
        with:
          path: ./artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.event.inputs.releaseVersion }}
          tag_name: ${{ github.event.inputs.releaseVersion }}
          draft: false
          prerelease: ${{ startsWith(github.event.inputs.releaseVersion, '0.') }}
          files: ./artifacts/*/*
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish Package on pub.dev
        run: dart pub publish --force
        working-directory: ./dart
      - name: Extract branch name
        shell: bash
        run: echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
        id: extract_branch
      - name: Set next version of Dart artifact
        uses: fjogeleit/yaml-update-action@main
        with:
          valueFile: 'dart/pubspec.yaml'
          propertyPath: 'version'
          value: ${{ github.event.inputs.developmentVersion }}
          message: "prepare dev version ${{ github.event.inputs.developmentVersion }} of LCE tool"
          branch: ${{ steps.extract_branch.outputs.branch }}
          createPR: false
